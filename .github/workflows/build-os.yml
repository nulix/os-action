name: Build and Upload NULIX OS Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      machine:
        description: "Override MACHINE"
        required: false
        type: string
      distro:
        description: "Override DISTRO"
        required: false
        type: string
      apps_repo:
        description: "Apps repository URL"
        required: false
        type: string
      apps_git_ref:
        description: "Apps repository git ref"
        required: false
        type: string

env:
  MACHINE: ${{ inputs.machine || 'raspberry-pi3' }}
  DISTRO: ${{ inputs.distro || 'alpine-docker' }}
  APPS_REPO: ${{ inputs.apps_repo || 'https://github.com/nulix/apps.git' }}
  APPS_GIT_REF: ${{ inputs.apps_git_ref || 'main' }}

jobs:
  build-os:
    runs-on: ubuntu-24.04-arm
    name: Build and Upload NULIX OS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            action.yml
            docker-compose.yml
      - name: Build NULIX OS
        uses: ./
        with:
          step_name: build-os
          machine: ${{ env.MACHINE }}
          distro: ${{ env.DISTRO }}
          apps_repo: ${{ env.APPS_REPO }}
          apps_git_ref: ${{ env.APPS_GIT_REF }}
          git_token: ${{ secrets.GIT_TOKEN }}
          upd8_keys: ${{ secrets.UPD8_KEYS }}
          machine_reg_token: ${{ secrets.MACHINE_REG_TOKEN }}
          ssh_public_key: ${{ vars.SSH_PUBLIC_KEY }}
          ssl_cert: ${{ vars.SSL_CERT }}
          upd8_api_url: ${{ vars.UPD8_API_URL }}
      - name: Upload OS image
        uses: actions/upload-artifact@v4
        with:
          name: nulix-os-${{ env.MACHINE }}
          path: nulix-os/build/deploy/${{ env.MACHINE }}/nulix-os-*.img.bz2
          retention-days: 7 # Keep the artifact for 7 days
